<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Coupon Management</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" type="image/x-icon" href="/user-assets/images/icons/FAVICON SW.png"/>
    <link href="admin-assets/css/main.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <style>
        .btn-warning-block { background-color: #ff7700; color: white; }
        .btn-success-unblock { background-color: #28a745; color: white; }
    </style>
</head>
<body>
    <div class="screen-overlay"></div>
    <%- include('./partials/adminAside.ejs') %>
    <main class="main-wrap">
        <%- include('./partials/adminNav.ejs') %>
        <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Coupon</h2>
                    <p>Add, edit or delete a Coupon</p>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <form id="couponForm">
                                <input type="hidden" id="coupon-id" value="">
                                <div class="container">
                                    <div class="mb-4">
                                        <label for="couponName" class="form-label">Coupon Name</label>
                                        <input type="text" placeholder="Enter the coupon name" name="couponName" class="form-control" id="coupon_name" required />
                                    </div>
                                    <div class="mb-4">
                                        <label for="couponCode" class="form-label">Coupon Code</label>
                                        <input type="text" placeholder="Enter the coupon code" name="couponCode" class="form-control" id="coupon_code" required />
                                    </div>
                                    <div class="mb-4">
                                        <label for="minimumPurchase" class="form-label">Minimum Purchase</label>
                                        <input type="text" placeholder="Enter minimum purchase amount" name="minimumPurchase" class="form-control" id="minimum_purchase" required />
                                    </div>
                                    <div class="mb-4">
                                        <label for="discount" class="form-label">Discount In Percentage</label>
                                        <input type="text" placeholder="Enter discount value" name="discountInPercentage" class="form-control" id="discount_percentage" required />
                                    </div>
                                    <div class="mb-4">
                                        <label for="date" class="form-label">Expiry Date</label>
                                        <input type="date" name="expiryDate" class="form-control" id="expiry_date" required />
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary" id="submitBtn">Add Coupon</button>
                                    <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
                                </div>
                            </form>
                        </div>
                        <div class="col-md-9">
                            <div class="table-responsive">
                                <table class="table table-hover" id="couponTable">
                                    <thead>
                                        <tr>
                                            <th class="text-center">No.</th>
                                            <th>Name</th>
                                            <th>Code</th>
                                            <th>Min Price</th>
                                            <th>Discount %</th>
                                            <th>End Date</th>
                                            <th>Status</th>
                                            <th class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="couponBody">
                                        <% if (coupon && coupon.length > 0) { %>
                                            <% for (let i = 0; i < coupon.length; i++) { %>
                                                <tr class="coupon-row" data-coupon-id="<%= coupon[i]._id %>" 
                                                    data-name="<%= coupon[i].couponName %>"
                                                    data-code="<%= coupon[i].couponCode %>"
                                                    data-min="<%= coupon[i].minimumPurchase %>"
                                                    data-discount="<%= coupon[i].discountInPercentage %>"
                                                    data-date="<%= new Date(coupon[i].expiryDate).toISOString().split('T')[0] %>">
                                                    <td class="text-center"><%= i + 1 %></td>
                                                    <td><b class="coupon-name"><%= coupon[i].couponName %></b></td>
                                                    <td><b class="coupon-code"><%= coupon[i].couponCode %></b></td>
                                                    <td><b class="coupon-min"><%= coupon[i].minimumPurchase %></b></td>
                                                    <td><b class="coupon-discount"><%= coupon[i].discountInPercentage %>%</b></td>
                                                    <td><b class="coupon-date"><%= new Date(coupon[i].expiryDate).toLocaleDateString() %></b></td>
                                                    <td>
                                                        <span class="badge rounded-pill coupon-status <%= coupon[i].isActive ? 'alert-success' : 'alert-danger' %>">
                                                            <%= coupon[i].isActive ? 'Active' : 'Inactive' %>
                                                        </span>
                                                    </td>
                                                    <td class="text-end">
                                                        <button type="button" class="btn btn-info rounded btn-sm me-2 edit-coupon-btn" data-coupon-id="<%= coupon[i]._id %>">Edit</button>
                                                        <button type="button" class="btn btn-sm block-unblock-coupon <%= coupon[i].isActive ? 'btn-warning-block' : 'btn-success-unblock' %>" data-coupon-id="<%= coupon[i]._id %>">
                                                            <%= coupon[i].isActive ? 'Block' : 'Unblock' %>
                                                        </button>
                                                        <button type="button" class="btn btn-danger rounded btn-sm delete-coupon-btn" data-coupon-id="<%= coupon[i]._id %>">Delete</button>
                                                    </td>
                                                </tr>
                                            <% } %>
                                        <% } else { %>
                                            <tr><td colspan="8">No coupons available.</td></tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="admin-assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="admin-assets/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>

    <script>
        let editingCouponId = null;

        // Form submission
        document.getElementById("couponForm").addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const couponId = document.getElementById('coupon-id').value;
            const data = {
                couponName: document.getElementById('coupon_name').value,
                couponCode: document.getElementById('coupon_code').value,
                minimumPurchase: document.getElementById('minimum_purchase').value,
                discountInPercentage: document.getElementById('discount_percentage').value,
                expiryDate: document.getElementById('expiry_date').value,
            };

            try {
                let endpoint, method;
                
                if (couponId) {
                    // Edit mode
                    data.couponId = couponId;
                    endpoint = '/admin/editCoupon';
                    method = 'POST';
                } else {
                    // Add mode
                    endpoint = '/admin/addCoupon';
                    method = 'POST';
                }

                const response = await fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                const result = await response.json();

                if (result.success) {
                    if (couponId) {
                        // Update table row
                        const row = document.querySelector(`.coupon-row[data-coupon-id="${couponId}"]`);
                        row.querySelector('.coupon-name').textContent = data.couponName;
                        row.querySelector('.coupon-code').textContent = data.couponCode;
                        row.querySelector('.coupon-min').textContent = data.minimumPurchase;
                        row.querySelector('.coupon-discount').textContent = data.discountInPercentage + '%';
                        row.querySelector('.coupon-date').textContent = new Date(data.expiryDate).toLocaleDateString();

                        Toastify({
                            text: "Coupon updated successfully!",
                            duration: 2000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "#4CAF50",
                        }).showToast();
                    } else {
                        Toastify({
                            text: "Coupon added successfully!",
                            duration: 2000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "#4CAF50",
                        }).showToast();
                        
                        setTimeout(() => location.reload(), 2000);
                    }
                    
                    // Reset form
                    resetForm();
                } else {
                    Toastify({
                        text: result.errors?.join(", ") || result.message,
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#FF0000",
                    }).showToast();
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });

        // Reset form to add mode
        function resetForm() {
            document.getElementById('coupon-id').value = '';
            document.getElementById("couponForm").reset();
            document.getElementById('submitBtn').textContent = 'Add Coupon';
            document.getElementById('cancelBtn').style.display = 'none';
            editingCouponId = null;
        }

        // Cancel edit
        document.getElementById('cancelBtn').addEventListener('click', resetForm);

        // Edit Button Click
        document.getElementById('couponBody').addEventListener('click', async (e) => {
            
            if (e.target.classList.contains('edit-coupon-btn')) {
                const couponId = e.target.getAttribute('data-coupon-id');
                const row = document.querySelector(`.coupon-row[data-coupon-id="${couponId}"]`);
                
                // Get data from table row attributes
                const couponName = row.getAttribute('data-name');
                const couponCode = row.getAttribute('data-code');
                const minimumPurchase = row.getAttribute('data-min');
                const discountInPercentage = row.getAttribute('data-discount');
                const expiryDate = row.getAttribute('data-date');
                
                // Populate form with coupon data
                document.getElementById('coupon-id').value = couponId;
                document.getElementById('coupon_name').value = couponName;
                document.getElementById('coupon_code').value = couponCode;
                document.getElementById('minimum_purchase').value = minimumPurchase;
                document.getElementById('discount_percentage').value = discountInPercentage;
                document.getElementById('expiry_date').value = expiryDate;
                
                // Update button labels
                document.getElementById('submitBtn').textContent = 'Update Coupon';
                document.getElementById('cancelBtn').style.display = 'block';
                
                // Scroll to form
                document.getElementById('couponForm').scrollIntoView({ behavior: 'smooth' });
            }

            // Block/Unblock Button Click
            if (e.target.classList.contains('block-unblock-coupon')) {
                const couponId = e.target.getAttribute('data-coupon-id');
                const isActive = e.target.classList.contains('btn-warning-block');
                const endpoint = isActive ? `/admin/blockCoupon?id=${couponId}` : `/admin/unblockCoupon?id=${couponId}`;

                try {
                    const response = await fetch(endpoint, { method: 'GET' });
                    const result = await response.json();

                    if (result.success) {
                        const row = document.querySelector(`.coupon-row[data-coupon-id="${couponId}"]`);
                        const statusBadge = row.querySelector('.coupon-status');
                        const btn = e.target;

                        if (isActive) {
                            statusBadge.textContent = 'Inactive';
                            statusBadge.classList.remove('alert-success');
                            statusBadge.classList.add('alert-danger');
                            btn.textContent = 'Unblock';
                            btn.classList.remove('btn-warning-block');
                            btn.classList.add('btn-success-unblock');
                        } else {
                            statusBadge.textContent = 'Active';
                            statusBadge.classList.remove('alert-danger');
                            statusBadge.classList.add('alert-success');
                            btn.textContent = 'Block';
                            btn.classList.remove('btn-success-unblock');
                            btn.classList.add('btn-warning-block');
                        }

                        Toastify({
                            text: isActive ? "Coupon blocked!" : "Coupon unblocked!",
                            duration: 2000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "#4CAF50",
                        }).showToast();
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            }

            // Delete Button Click
            if (e.target.classList.contains('delete-coupon-btn')) {
                const couponId = e.target.getAttribute('data-coupon-id');
                
                const { isConfirmed } = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (isConfirmed) {
                    try {
                        const response = await fetch('/admin/couponDelete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ couponId: couponId })
                        });
                        const result = await response.json();

                        if (result.success) {
                            document.querySelector(`.coupon-row[data-coupon-id="${couponId}"]`).remove();
                            
                            // Reset form if editing this coupon
                            if (document.getElementById('coupon-id').value === couponId) {
                                resetForm();
                            }
                            
                            Toastify({
                                text: "Coupon deleted successfully!",
                                duration: 2000,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "#4CAF50",
                            }).showToast();
                        }
                    } catch (error) {
                        console.error("Error:", error);
                    }
                }
            }
        });
    </script>
</body>
</html>