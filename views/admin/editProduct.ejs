<!DOCTYPE HTML>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Edit product</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/user-assets/images/icons/FAVICON SW.png">
    <!-- Template CSS -->
    <link href="admin-assets/css/main.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    
    <!-- Toastify CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <style>
        .image-container {
            display: inline-block;
            position: relative;
            margin: 5px;
        }

        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .remove-image {
            position: absolute;
            top: 0;
            right: 0;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            width: 20px;
            height: 20px;
            font-size: 12px;
        }

        .crop-image {
            position: absolute;
            bottom: 0;
            left: 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 10px;
        }

        .view-image {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 10px;
        }

        .small-input {
            max-width: 100px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 50px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .img-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 80vh;
            overflow: hidden;
        }

        .img-container img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        .crop-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        .image-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px;
            position: relative;
            width: 80px;
            background: #fafafa;
        }

        .img-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            margin-bottom: 4px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .file-name {
            font-size: 9px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            max-width: 70px;
            line-height: 1.2;
        }

        .upload-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .existing-images {
            margin-bottom: 15px;
        }

        .existing-images h6 {
            margin-bottom: 10px;
            color: #333;
        }

        .new-images {
            margin-top: 15px;
        }

        .new-images h6 {
            margin-bottom: 10px;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="screen-overlay"></div>
    <%- include('./partials/adminAside.ejs') %>
    <main class="main-wrap">
        <%- include('./partials/adminNav.ejs') %>

        <% if (locals.products) { %>
            <form id="productAdd" action="/admin/updateProduct?productId=<%= products._id %>" method="post"
                enctype="multipart/form-data">
                <input type="hidden" id="productId" name="productId" value="<%= products._id %>">

                <section class="content-main">
                    <div class="row">
                        <div class="col-9">
                            <div class="content-header">
                                <h2 class="content-title">Edit Product</h2>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card mb-4">
                                <div class="card-header"></div>
                                <div class="card-body">
                                    <div class="mb-4">
                                        <label for="product_name" class="form-label">Product Name</label>
                                        <input type="text" value="<%= products.productName %>"
                                            class="form-control" id="product_name" name="productName">
                                        <div id="productNameError" class="error"></div>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label">Full Description</label>
                                        <textarea class="form-control" rows="4"
                                            name="description"><%= products.description %></textarea>
                                        <div id="descriptionError" class="error"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="mb-4">
                                                <label class="form-label">Price</label>
                                                <input placeholder="â‚¹" type="text" class="form-control"
                                                    pattern="^[1-9][0-9]*(\.[0-9]+)?$" name="realPrice"
                                                    value="<%= products.realPrice %>">
                                                <div id="realPriceError" class="error"></div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="mb-4"></div>
                                        </div>
                                        <div class="col-lg-4">
                                            <div class="mb-4">
                                                <label class="form-label">Brand</label>
                                                <div class="row gx-2">
                                                    <input placeholder="Brand" type="text" class="form-control"
                                                        name="brandName" id="brand"
                                                        value="<%= products.brandName%>">
                                                    <div id="brandError" class="error" style="color: red;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-4"></div>
                                </div>
                            </div>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h4>Size and Quantity</h4>
                                    <div class="table-responsive">
                                        <table class="table table-bordered" id="sizeQuantityTable">
                                            <thead>
                                                <tr>
                                                    <th>Size</th>
                                                    <th>Quantity</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="sizeQuantityContainer">
                                                <% products.sizes.forEach((size, index)=> { %>
                                                    <tr id="row<%= index %>">
                                                        <td>
                                                            <input type="text" value="<%= size.size %>"
                                                                class="form-control small-input"
                                                                id="size<%= size.size %>"
                                                                name="size<%= size.size %>"
                                                                oninput="validateInput(this, 'size')">
                                                            <div id="size<%= size.size %>Error" class="error"
                                                                style="color: red;"></div>
                                                        </td>
                                                        <td>
                                                            <input type="text" value="<%= size.quantity %>"
                                                                class="form-control small-input"
                                                                id="quantity<%= size.size %>"
                                                                name="quantity<%= size.size %>"
                                                                oninput="validateInput(this, 'quantity')">
                                                            <div id="quantity<%= size.size %>Error"
                                                                class="error" style="color: red;"></div>
                                                        </td>
                                                        <td>
                                                            <button type="button"
                                                                class="btn btn-danger btn-sm cancel-btn"
                                                                data-row="row<%= index %>"
                                                                onclick="removeRow('row<%= index %>')">Remove</button>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" id="addSizeQuantityBtn"
                                        class="btn btn-primary mt-3">Add Another Size and Quantity</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h4>Media</h4>
                                </div>
                                <div class="card-body">
                                    <!-- Existing Images Section -->
                                    <div class="existing-images">
                                        <h6>Existing Images</h6>
                                        <div id="imagePreview" style="position: relative;">
                                            <% if (products.images) { %>
                                                <% products.images.forEach((image, i)=> { %>
                                                    <div class="image-container" data-existing-index="<%= i %>">
                                                        <% if (image) { %>
                                                            <img src="<%= image %>" alt="Existing Image"
                                                                class="preview-image">
                                                            <!-- Remove button -->
                                                            <button type="button" class="remove-image"
                                                                data-index="<%= i %>"
                                                                onclick="removeExistingImage('<%= i %>')">&times;</button>
                                                            <!-- Crop button -->
                                                            <button type="button" class="crop-image"
                                                                onclick="cropExistingImage('<%= i %>', '<%= image %>')">Crop</button>
                                                            <!-- View button -->
                                                            <!-- <button type="button" class="view-image"
                                                                onclick="viewImage('<%= image %>')">View</button> -->
                                                            <input type="hidden" name="existingImages[]"
                                                                value="<%= image %>">
                                                        <% } %>
                                                    </div>
                                                <% }); %>
                                            <% } else { %>
                                                <img src="admin-assets/imgs/theme/upload.svg" alt="Upload Icon">
                                            <% } %>
                                        </div>
                                    </div>

                                    <!-- New Images Section -->
                                    <div class="new-images">
                                        <h6>Add New Images</h6>
                                        <div class="upload-info">
                                            You can add additional images (Maximum 5 images total)
                                        </div>
                                        <input id="imageInput" class="form-control" type="file"
                                            accept="image/jpeg,image/jpg,image/png,image/webp" name="images"
                                            multiple onchange="handleImageSelection(event)">
                                        <div id="imageError" class="error"></div>
                                        
                                        <!-- Section to preview newly selected images -->
                                        <div class="image-preview-container" id="newImagePreview">
                                            <!-- New image previews will be displayed here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Crop Modal -->
                            <div id="cropModal" class="modal">
                                <div class="modal-content">
                                    <span class="close" onclick="closeCropModal()">&times;</span>
                                    <div class="img-container">
                                        <img id="cropImage" src="" alt="Image Preview">
                                        <div class="crop-controls">
                                            <button id="btn-crop" class="btn btn-success" type="button">Crop & Save</button>
                                            <button id="btn-cancel" class="btn btn-secondary" type="button">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- View Modal -->
                            <div id="viewModal" class="modal">
                                <div class="modal-content">
                                    <span class="close" onclick="closeViewModal()">&times;</span>
                                    <div class="img-container">
                                        <img id="viewImage" src="" alt="Image Preview" style="max-width: 100%; max-height: 80vh;">
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden fields for crop data -->
                            <input type="hidden" id="hiddenField1" name="hiddenField1" value="">
                            <input type="hidden" id="hiddenField2" name="hiddenField2" value="">
                            <input type="hidden" id="hiddenField3" name="hiddenField3" value="">
                            <input type="hidden" id="hiddenField4" name="hiddenField4" value="">
                            <input type="hidden" id="hiddenField5" name="hiddenField5" value="">

                            <div class="card mb-4">
                                <div class="card-header">
                                    <h4>Select Categories</h4>
                                </div>
                                <% if (categories) { %>
                                    <div class="card-body">
                                        <div class="row gx-2">
                                            <div class="col-sm-6 mb-3">
                                                <label class="form-label">Category</label>
                                                <select class="form-select" name="category">
                                                    <% categories.forEach(category=> { %>
                                                        <option value="<%= category.id %>"
                                                            <%=category.id===products.categoryId ? 'selected' : '' %>>
                                                            <%= category.categoryName %>
                                                        </option>
                                                    <% }); %>
                                                </select>
                                                <div id="categoryError" class="error"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card mb-4">
                                    <div class="card-header">
                                        <h4>Select Offer</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="row gx-2">
                                            <div class="col-sm-6 mb-3">
                                                <label class="form-label">Offers</label>
                                                <select class="form-select" name="offerId" id="offer">
                                                    <% for( let i=0; i < offer.length; i++ ) { %>
                                                        <option value="<%= offer[i]._id %>">
                                                            <%= offer[i].offerPercentage %>
                                                        </option>
                                                    <% } %>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% } %>
                            
                            <div class="row gx-2">
                                <button type="submit" class="btn btn-md rounded font-sm hover-up">Update
                                    Product</button>
                            </div>
                        </div>
                    </div>
                </section>
            </form>
        <% } %>

        <!-- Scripts -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>


        <script src="admin-assets/js/editProduct.js"></script>



                     
                
<!-- Toastify JS -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
                      
</body>

</html>