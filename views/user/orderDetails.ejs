<!DOCTYPE html>
<html lang="zxx">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Details - Soleway</title>
    <link rel="shortcut icon" href="/user-assets/images/icons/FAVICON SW.png" type="image/png">
    <link rel="stylesheet" href="/userMng-assets/css/vendor/vendor.min.css">
    <link rel="stylesheet" href="/userMng-assets/css/plugins/plugins.min.css">
    <link rel="stylesheet" href="/userMng-assets/css/style.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <%- include('./partials/solewayCss.ejs') %>

    <style>
        body { background-color: #f5f7fa; }
        .order-details-wrapper { max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 30px;
            border-radius: 15px;
            color: white;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        .page-header h2 { margin: 0; font-size: 32px; font-weight: 700; }
        .page-header p { margin: 10px 0 0 0; opacity: 0.9; font-size: 16px; }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        /* Order Info Card */
        .order-info-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .order-info-card h3 {
            font-size: 22px;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .info-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }
        .info-label {
            font-size: 13px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 16px;
            color: #1e293b;
            font-weight: 600;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-placed { background: #dcfce7; color: #166534; }
        .status-shipped { background: #dbeafe; color: #1e40af; }
        .status-delivered { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
        .status-returned { background: #fed7aa; color: #9a3412; }
        .status-pending { background: #fef3c7; color: #92400e; }

        /* Products Table */
        .products-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .products-card h3 {
            font-size: 22px;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .product-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .product-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .product-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .product-image {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            border: 2px solid #e2e8f0;
            flex-shrink: 0;
        }
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .product-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .product-name {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }
        .product-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #64748b;
        }
        .product-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Action Buttons */
        .btn-action {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .btn-cancel {
            background: #fee2e2;
            color: #991b1b;
        }
        .btn-cancel:hover {
            background: #fecaca;
            transform: translateY(-2px);
        }
        .btn-return {
            background: #fed7aa;
            color: #9a3412;
        }
        .btn-return:hover {
            background: #fdba74;
            transform: translateY(-2px);
        }
        .btn-pay {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .btn-pay:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        /* Address Card */
        .address-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .address-card h3 {
            font-size: 22px;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .address-content {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border-left: 3px solid #ec4899;
        }
        .address-content p {
            margin: 8px 0;
            color: #475569;
            font-size: 15px;
        }
        .address-content strong {
            color: #1e293b;
            font-weight: 600;
        }

        /* Download Invoice */
        .invoice-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .invoice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }

        @media (max-width: 768px) {
            .page-header h2 { font-size: 24px; }
            .info-grid { grid-template-columns: 1fr; }
            .product-item { flex-direction: column; text-align: center; }
            .product-actions { flex-direction: column; width: 100%; }
            .btn-action { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Header (same as your existing header) -->
    <header class="header-section d-none d-xl-block">
        <div class="header-wrapper">
            <div class="header-bottom header-bottom-color--black section-fluid sticky-header sticky-color--Black blackbg">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12 d-flex align-items-center justify-content-between color--Black blackbg">
                            <div class="header-logo">
                                <div class="logo">
                                    <a href="/"><img src="/userMng-assets/images/logo/1.png" alt=""></a>
                                </div>
                            </div>
                            <div class="main-menu menu-color--black menu-hover-color--Black">
                                <nav>
                                    <ul>
                                        <li><a href="/">Home</a></li>
                                        <li><a href="/Shop">Shop</a></li>
                                        <li><a href="/Blog">Blog</a></li>
                                        <li><a href="/About">About Us</a></li>
                                        <li><a href="/Contact">Contact Us</a></li>
                                    </ul>
                                </nav>
                            </div>
                            <ul class="header-action-link action-color--black action-hover-color--white">
                                <li>
                                    <a href="#offcanvas-about" class="offacnvas offside-about offcanvas-toggle">
                                        <i class="icon-menu"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <% if (locals.orderedData && locals.findUser) { %>
    <div class="breadcrumb-section breadcrumb-bg-color--white">
        <div class="breadcrumb-wrapper">
            <div class="container">
                <div class="col-12">
                    <h3 class="breadcrumb-title">Order Details</h3>
                    <div class="breadcrumb-nav breadcrumb-nav-color--black breadcrumb-nav-hover-color--white">
                        <nav aria-label="breadcrumb">
                            <ul>
                                <li><a href="/">Home</a></li>
                                <li><a href="/orders">My Orders</a></li>
                                <li class="active" aria-current="page">Order #<%= orderedData.orderId %></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="order-details-wrapper">
        <a href="/orders" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Orders
        </a>

        <div class="page-header">
            <h2><i class="fas fa-receipt"></i> Order #<%= orderedData.orderId %></h2>
            <p>Placed on <%= new Date(orderedData.orderDate).toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            }) %></p>
        </div>

        <!-- Order Info Card -->
        <div class="order-info-card">
            <h3><i class="fas fa-info-circle"></i> Order Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Order Status</div>
                    <div class="info-value">
                        <span class="status-badge status-<%= orderedData.orderStatus.toLowerCase().replace(' ', '-') %>" id="order-status">
                            <i class="fas fa-circle"></i>
                            <%= orderedData.orderStatus %>
                        </span>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Payment Status</div>
                    <div class="info-value" id="payment-status">
                        <%= orderedData.orderStatus === 'Cancelled' && (orderedData.paymentMethod === 'Online' || orderedData.paymentMethod === 'Wallet') ? 'Refund Processing' : orderedData.paymentStatus %>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Payment Method</div>
                    <div class="info-value"><%= orderedData.paymentMethod %></div>
                </div>

                <div class="info-item">
                    <div class="info-label">Total Amount</div>
                    <div class="info-value" style="color: #667eea; font-size: 20px;">₹<%= orderedData.totalAmount %></div>
                </div>

                <% if (orderedData.coupon && orderedData.coupon.discountAmount) { %>
                <div class="info-item">
                    <div class="info-label">Coupon Discount</div>
                    <div class="info-value" style="color: #10b981;">- ₹<%= orderedData.coupon.discountAmount %></div>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Products Card -->
      <!-- Products Card -->
<div class="products-card">
    <h3><i class="fas fa-box-open"></i> Ordered Products</h3>
    <div class="product-list">
        <% if (orderedData.products && orderedData.products.length > 0) { %>
            <% orderedData.products.forEach((product, index) => { %>
                <div class="product-item">
                    <div class="product-image">
                        <% if (product.productId && product.productId.images && product.productId.images.length > 0) { %>
                            <img src="<%= product.productId.images[0] %>" alt="Product Image">
                        <% } else { %>
                            <img src="/userMng-assets/images/placeholder.png" alt="No Image Available">
                        <% } %>
                    </div>
                    <div class="product-details">
                        <div class="product-name">
                            <%= product.productId && product.productId.productName ? product.productId.productName : 'Product Not Available' %>
                        </div>
                        <div class="product-meta">
                            <span><i class="fas fa-box"></i> Qty: <%= product.quantity || 'N/A' %></span>
                            <span><i class="fas fa-ruler"></i> Size: <%= product.size || 'N/A' %></span>
                            <span><i class="fas fa-rupee-sign"></i> ₹<%= product.productId && product.productId.realPrice ? product.productId.realPrice : 'N/A' %></span>
                        </div>
                    </div>
                    <div class="product-actions" id="action-cell-<%= orderedData._id %>">
                        <% if (orderedData.orderStatus === 'Order Placed' || orderedData.orderStatus === 'Shipped') { %>
                            <button class="btn-action btn-cancel" onclick="confirmCancel('<%= orderedData._id %>')">
                                <i class="fas fa-times-circle"></i> Cancel
                            </button>
                        <% } else if (orderedData.orderStatus === 'Delivered') { %>
                            <button class="btn-action btn-return" onclick="openReturnModal('<%= orderedData._id %>')">
                                <i class="fas fa-undo"></i> Return
                            </button>
                        <% } else if (orderedData.orderStatus === 'Pending') { %>
                            <button class="btn-action btn-pay" onclick="rePayment('<%= orderedData._id %>')">
                                <i class="fas fa-credit-card"></i> Pay Now
                            </button>
                        <% } else if (orderedData.orderStatus === 'Cancelled') { %>
                            <span style="color: #991b1b; font-weight: 600;">Order Cancelled</span>
                        <% } else if (orderedData.orderStatus === 'Returned') { %>
                            <span style="color: #9a3412; font-weight: 600;">Order Returned</span>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <p>No products found in this order.</p>
        <% } %>
    </div>
</div>

        <!-- Address Card -->
        <div class="address-card">
            <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>
            <% if (orderedData.address) { %>
            <div class="address-content">
                <p><strong><i class="fas fa-user"></i> Name:</strong> <%= orderedData.address.addressName %></p>
                <p><strong><i class="fas fa-phone"></i> Mobile:</strong> <%= orderedData.address.mobile %></p>
                <p><strong><i class="fas fa-home"></i> Address:</strong> <%= orderedData.address.homeAddress %></p>
                <p><strong><i class="fas fa-city"></i> City:</strong> <%= orderedData.address.city %></p>
                <p><strong><i class="fas fa-map"></i> District:</strong> <%= orderedData.address.district %></p>
                <p><strong><i class="fas fa-flag"></i> State:</strong> <%= orderedData.address.state %></p>
                <p><strong><i class="fas fa-map-pin"></i> Pincode:</strong> <%= orderedData.address.pincode %></p>
            </div>
            <% } else { %>
                <p>Address information is not available.</p>
            <% } %>
        </div>

        <!-- Invoice Button -->
        <% if (orderedData.paymentMethod === 'Online' && orderedData.paymentStatus === 'Received') { %>
        <a href="/order/invoice/download/<%= orderedData.orderId %>" class="invoice-btn">
            <i class="fas fa-file-download"></i> Download Invoice
        </a>
        <% } %>
    </div>
    <% } %>

    <!-- Return Reason Modal -->
    <div class="modal fade" id="reasonModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Return Reason</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="returnReasonForm">
                        <div class="form-group">
                            <label for="returnReason">Reason for returning the product:</label>
                            <textarea class="form-control" id="returnReason" name="returnReason" rows="3" required></textarea>
                        </div>
                        <input type="hidden" id="orderId" name="orderId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitReturnReason()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('./partials/userFooter.ejs') %>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/userMng-assets/js/vendor/vendor.min.js"></script>
    <script src="/userMng-assets/js/plugins/plugins.min.js"></script>
    <script src="/userMng-assets/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        function confirmCancel(orderId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to cancel this order?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Yes, cancel it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/orderCancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId: orderId, actionType: 'cancel' })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.orderStatus === 'Cancelled') {
                            Swal.fire({
                                title: 'Cancelled!',
                                text: 'Your order has been canceled successfully.',
                                icon: 'success',
                                confirmButtonColor: '#667eea'
                            }).then(() => window.location.reload());
                        } else {
                            Swal.fire('Error', data.message || 'Failed to cancel the order.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error', 'An error occurred while canceling the order.', 'error');
                    });
                }
            });
        }

        function openReturnModal(orderId) {
            document.getElementById('orderId').value = orderId;
            $('#reasonModal').modal('show');
        }

        async function submitReturnReason() {
            const returnReason = document.getElementById('returnReason').value;
            const orderId = document.getElementById('orderId').value;

            if (returnReason.trim() === "") {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Please enter a return reason.' });
                return;
            }

            try {
                const response = await fetch('/returnOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, returnReason })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    Swal.fire({ icon: 'success', title: 'Success', text: data.message });
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'Unknown error' });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred.' });
            }

            $('#reasonModal').modal('hide');
            document.getElementById('returnReasonForm').reset();
        }

        async function rePayment(orderId) {
            try {
                const response = await fetch('/rePay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId })
                });
                const result = await response.json();

                if (result.success) {
                    const options = {
                        key: "rzp_test_72sGbnDINNYlKN",
                        amount: result.amount,
                        currency: "INR",
                        name: "SOLEWAY",
                        description: "Order Payment",
                        order_id: result.orderId,
                        handler: async function (response) {
                            const verifyResponse = await fetch('/rePay', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    orderId,
                                    paymentId: response.razorpay_payment_id
                                })
                            });
                            const verifyResult = await verifyResponse.json();

                            if (verifyResult.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Payment Successful',
                                    text: 'Your payment was successful!',
                                    confirmButtonColor: '#667eea'
                                }).then(() => window.location.reload());
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Verification Failed',
                                    text: 'Payment verification failed. Please try again.'
                                });
                            }
                        },
                        theme: { color: "#667eea" }
                    };
                    const razorpay = new Razorpay(options);
                    razorpay.open();
                } else {
                    Swal.fire({ icon: 'error', title: 'Payment Failed', text: result.message });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({ icon: 'error', title: 'Error', text: 'An unexpected error occurred.' });
            }
        }
    </script>
</body>
</html>