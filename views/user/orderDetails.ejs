<!DOCTYPE html>
<html lang="zxx">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Details - Soleway</title>
    <link rel="shortcut icon" href="/user-assets/images/icons/FAVICON SW.png" type="image/png">
    <link rel="stylesheet" href="/userMng-assets/css/vendor/vendor.min.css">
    <link rel="stylesheet" href="/userMng-assets/css/plugins/plugins.min.css">
    <link rel="stylesheet" href="/userMng-assets/css/style.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <%- include('./partials/solewayCss.ejs') %>
    <link rel="stylesheet" href="/userMng-assets/css/orderDetails.css">
</head>
<body>
    <!-- Header -->
    <header class="header-section d-none d-xl-block">
        <div class="header-wrapper">
            <div class="header-bottom header-bottom-color--black section-fluid sticky-header sticky-color--Black blackbg">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12 d-flex align-items-center justify-content-between color--Black blackbg">
                            <div class="header-logo">
                                <div class="logo">
                                    <a href="/"><img src="/userMng-assets/images/logo/1.png" alt=""></a>
                                </div>
                            </div>
                            <div class="main-menu menu-color--black menu-hover-color--Black">
                                <nav>
                                    <ul>
                                        <li><a href="/">Home</a></li>
                                        <li><a href="/Shop">Shop</a></li>
                                        <li><a href="/Blog">Blog</a></li>
                                        <li><a href="/About">About Us</a></li>
                                        <li><a href="/Contact">Contact Us</a></li>
                                    </ul>
                                </nav>
                            </div>
                            <ul class="header-action-link action-color--black action-hover-color--white">
                                <li>
                                    <a href="#offcanvas-about" class="offacnvas offside-about offcanvas-toggle">
                                        <i class="icon-menu"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <% if (locals.orderedData && locals.findUser) { %>
    <div class="breadcrumb-section breadcrumb-bg-color--white">
        <div class="breadcrumb-wrapper">
            <div class="container">
                <div class="col-12">
                    <h3 class="breadcrumb-title">Order Details</h3>
                    <div class="breadcrumb-nav breadcrumb-nav-color--black breadcrumb-nav-hover-color--white">
                        <nav aria-label="breadcrumb">
                            <ul>
                                <li><a href="/">Home</a></li>
                                <li><a href="/orders">My Orders</a></li>
                                <li class="active" aria-current="page">Order #<%= orderedData.orderId %></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="order-details-wrapper">
        <a href="/orders" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Orders
        </a>

        <div class="page-header">
            <h2><i class="fas fa-receipt"></i> Order #<%= orderedData.orderId %></h2>
            <p>Placed on <%= new Date(orderedData.orderDate).toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            }) %></p>
        </div>

        <!-- Order Info Card -->
        <div class="order-info-card">
            <h3><i class="fas fa-info-circle"></i> Order Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Order Status</div>
                    <div class="info-value">
                        <span class="status-badge status-<%= orderedData.orderStatus.toLowerCase().replace(' ', '-') %>" id="order-status">
                            <i class="fas fa-circle"></i>
                            <%= orderedData.orderStatus %>
                        </span>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-label">Payment Status</div>
                    <div class="info-value" id="payment-status">
                        <%= orderedData.orderStatus === 'Cancelled' && (orderedData.paymentMethod === 'Online' || orderedData.paymentMethod === 'Wallet') ? 'Refund Processing' : orderedData.paymentStatus %>
                    </div>
                </div>

                <div class="info-item">
                    <div class="info-label">Payment Method</div>
                    <div class="info-value"><%= orderedData.paymentMethod %></div>
                </div>

                <div class="info-item">
                    <div class="info-label">Total Amount</div>
                    <div class="info-value" style="color: #667eea; font-size: 20px;">₹<%= orderedData.totalAmount %></div>
                </div>

                <% if (orderedData.coupon && orderedData.coupon.discountAmount) { %>
                <div class="info-item">
                    <div class="info-label">Coupon Discount</div>
                    <div class="info-value" style="color: #10b981;">- ₹<%= orderedData.coupon.discountAmount %></div>
                </div>
                <% } %>
            </div>
        </div>

        <!-- Products Card -->
        <div class="products-card">
            <h3><i class="fas fa-box-open"></i> Ordered Products</h3>
            <div class="product-list">
                <% if (orderedData.products && orderedData.products.length > 0) { %>
                    <% orderedData.products.forEach((product, index) => { %>
                        <div class="product-item">
                            <div class="product-image">
                                <% if (product.productId && product.productId.images && product.productId.images.length > 0) { %>
                                    <img src="<%= product.productId.images[0] %>" alt="Product Image">
                                <% } else { %>
                                    <img src="/userMng-assets/images/placeholder.png" alt="No Image Available">
                                <% } %>
                            </div>
                            <div class="product-details">
                                <div class="product-name">
                                    <%= product.productId && product.productId.productName ? product.productId.productName : 'Product Not Available' %>
                                </div>
                                <div class="product-meta">
                                    <span><i class="fas fa-box"></i> Qty: <%= product.quantity || 'N/A' %></span>
                                    <span><i class="fas fa-ruler"></i> Size: <%= product.size || 'N/A' %></span>
                                    <span><i class="fas fa-rupee-sign"></i> ₹<%= product.productId && product.productId.realPrice ? product.productId.realPrice : 'N/A' %></span>
                                </div>
                            </div>
                            <div class="product-actions" id="action-cell-<%= orderedData._id %>">
                                <% if (orderedData.orderStatus === 'Order Placed' || orderedData.orderStatus === 'Shipped') { %>
                                    <button class="btn-action btn-cancel" onclick="confirmCancel('<%= orderedData._id %>')">
                                        <i class="fas fa-times-circle"></i> Cancel
                                    </button>
                                <% } else if (orderedData.orderStatus === 'Delivered') { %>
                                    <button class="btn-action btn-return" onclick="openReturnModal('<%= orderedData._id %>')">
                                        <i class="fas fa-undo"></i> Return
                                    </button>
                                <% } else if (orderedData.orderStatus === 'Pending') { %>
                                    <button class="btn-action btn-pay" onclick="rePayment('<%= orderedData._id %>')">
                                        <i class="fas fa-credit-card"></i> Pay Now
                                    </button>
                                <% } else if (orderedData.orderStatus === 'Cancelled') { %>
                                    <span style="color: #991b1b; font-weight: 600;">Order Cancelled</span>
                                <% } else if (orderedData.orderStatus === 'Returned') { %>
                                    <span style="color: #9a3412; font-weight: 600;">Order Returned</span>
                                <% } %>
                            </div>
                        </div>
                    <% }) %>
                <% } else { %>
                    <p>No products found in this order.</p>
                <% } %>
            </div>
        </div>

        <!-- Address Card -->
        <div class="address-card">
            <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>
            <% if (orderedData.address) { %>
            <div class="address-content">
                <p><strong><i class="fas fa-user"></i> Name:</strong> <%= orderedData.address.addressName %></p>
                <p><strong><i class="fas fa-phone"></i> Mobile:</strong> <%= orderedData.address.mobile %></p>
                <p><strong><i class="fas fa-home"></i> Address:</strong> <%= orderedData.address.homeAddress %></p>
                <p><strong><i class="fas fa-city"></i> City:</strong> <%= orderedData.address.city %></p>
                <p><strong><i class="fas fa-map"></i> District:</strong> <%= orderedData.address.district %></p>
                <p><strong><i class="fas fa-flag"></i> State:</strong> <%= orderedData.address.state %></p>
                <p><strong><i class="fas fa-map-pin"></i> Pincode:</strong> <%= orderedData.address.pincode %></p>
            </div>
            <% } else { %>
                <p>Address information is not available.</p>
            <% } %>
        </div>

        <!-- Invoice Button -->
        <% if (orderedData.paymentMethod === 'Online' && orderedData.paymentStatus === 'Received') { %>
        <a href="/order/invoice/download/<%= orderedData.orderId %>" class="invoice-btn">
            <i class="fas fa-file-download"></i> Download Invoice
        </a>
        <% } %>
    </div>
    <% } %>

    <!-- Cancellation Reason Modal -->
    <div class="modal fade" id="cancellationModal" tabindex="-1" role="dialog" aria-labelledby="cancellationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancellationModalLabel">Cancellation Reason</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="cancellationReasonForm">
                        <div class="form-group">
                            <label for="cancellationReason">Reason for cancelling the order:</label>
                            <textarea class="form-control" id="cancellationReason" name="cancellationReason" rows="3" required></textarea>
                        </div>
                        <input type="hidden" id="cancellationOrderId" name="cancellationOrderId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitCancellationReason()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Return Reason Modal -->
    <div class="modal fade" id="reasonModal" tabindex="-1" role="dialog" aria-labelledby="reasonModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reasonModalLabel">Return Reason</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="returnReasonForm">
                        <div class="form-group">
                            <label for="returnReason">Reason for returning the product:</label>
                            <textarea class="form-control" id="returnReason" name="returnReason" rows="3" required></textarea>
                        </div>
                        <input type="hidden" id="orderId" name="orderId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitReturnReason()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('./partials/userFooter.ejs') %>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="/userMng-assets/js/vendor/vendor.min.js"></script>
    <script src="/userMng-assets/js/plugins/plugins.min.js"></script>
    <script src="/userMng-assets/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        function confirmCancel(orderId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to cancel this order?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#667eea',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Yes, cancel it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('cancellationOrderId').value = orderId;
                    $('#cancellationModal').modal('show');
                }
            });
        }

        async function submitCancellationReason() {
            const cancellationReason = document.getElementById('cancellationReason').value;
            const orderId = document.getElementById('cancellationOrderId').value;

            if (cancellationReason.trim() === "") {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Please enter a cancellation reason.' });
                return;
            }

            try {
                const response = await fetch('/orderCancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        orderId: orderId, 
                        actionType: 'cancel',
                        cancellationReason: cancellationReason
                    })
                });

                const data = await response.json();

                if (data.orderStatus === 'Cancelled') {
                    Swal.fire({
                        title: 'Cancelled!',
                        text: 'Your order has been canceled successfully.',
                        icon: 'success',
                        confirmButtonColor: '#667eea'
                    }).then(() => window.location.reload());
                } else {
                    Swal.fire('Error', data.message || 'Failed to cancel the order.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while canceling the order.', 'error');
            }

            $('#cancellationModal').modal('hide');
            document.getElementById('cancellationReasonForm').reset();
        }

        function openReturnModal(orderId) {
            document.getElementById('orderId').value = orderId;
            $('#reasonModal').modal('show');
        }

        async function submitReturnReason() {
            const returnReason = document.getElementById('returnReason').value;
            const orderId = document.getElementById('orderId').value;

            if (returnReason.trim() === "") {
                Swal.fire({ icon: 'error', title: 'Error', text: 'Please enter a return reason.' });
                return;
            }

            try {
                const response = await fetch('/returnOrder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, returnReason })
                });
                const data = await response.json();

                if (response.ok && data.success) {
                    Swal.fire({ icon: 'success', title: 'Success', text: data.message });
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    Swal.fire({ icon: 'error', title: 'Error', text: data.message || 'Unknown error' });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({ icon: 'error', title: 'Error', text: 'An error occurred.' });
            }

            $('#reasonModal').modal('hide');
            document.getElementById('returnReasonForm').reset();
        }

        async function rePayment(orderId) {
            try {
                const response = await fetch('/rePay', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId })
                });
                const result = await response.json();

                if (result.success) {
                    const options = {
                        key: "rzp_test_72sGbnDINNYlKN",
                        amount: result.amount,
                        currency: "INR",
                        name: "SOLEWAY",
                        description: "Order Payment",
                        order_id: result.orderId,
                        handler: async function (response) {
                            const verifyResponse = await fetch('/rePay', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    orderId,
                                    paymentId: response.razorpay_payment_id
                                })
                            });
                            const verifyResult = await verifyResponse.json();

                            if (verifyResult.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Payment Successful',
                                    text: 'Your payment was successful!',
                                    confirmButtonColor: '#667eea'
                                }).then(() => window.location.reload());
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Verification Failed',
                                    text: 'Payment verification failed. Please try again.'
                                });
                            }
                        },
                        theme: { color: "#667eea" }
                    };
                    const razorpay = new Razorpay(options);
                    razorpay.open();
                } else {
                    Swal.fire({ icon: 'error', title: 'Payment Failed', text: result.message });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({ icon: 'error', title: 'Error', text: 'An unexpected error occurred.' });
            }
        }
    </script>
</body>
</html>